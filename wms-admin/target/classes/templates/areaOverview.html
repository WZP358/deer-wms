<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org">
<head>
    <th:block th:include="include :: header('货区一览')" />
    <style>
        [v-cloak] { display: none; }
        
        * {
            margin: 0;
            padding: 0;
            user-select: none;
        }

        .container-div {
            padding: 20px;
        }

        .clearFloat:after {
            display: block;
            clear: both;
            content: "";
            visibility: hidden;
            height: 0
        }

        .clearFloat {
            zoom: 1
        }

        .leftBox {
            float: left;
        }

        .rightBox {
            float: right;
        }

        .bigShelfBox {
            width: 90%;
            box-shadow: 0px 2px 12px 0px rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            margin-left: 1%;
            margin-right: 1%;
            border: 1px solid #ebeef5;
            background: #fff;
            padding: 30px 25px 35px;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
        }

        .bigShelfBox .shelfBox {
            padding: 8px;
            box-sizing: border-box;
        }

        .bigShelfBox .shelfBox .shelf {
            width: 100%;
            padding-bottom: 100%;
            height: 0;
            background: #d3d3d3;
            position: relative;
            border: 3px solid #dfe4ed;
            border-radius: 6px;
            transition: box-shadow 0.18s ease, border-color 0.18s ease;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
            box-sizing: border-box;
        }
        
        .bigShelfBox .shelfBox .shelf:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .bigShelfBox .shelfBox .shelf > span {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #409eff;
            color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .bigShelfBox .shelfBox .shelf.success {
            background: #90ee90;
        }

        .bigShelfBox .shelfBox .shelf.danger {
            background: #f08080;
        }

        .bigShelfBox .shelfBox .shelf.warning {
            background: #ffa500;
        }

        .bigShelfBox .shelfBox .shelf.selected {
            border-color: #409eff;
            box-shadow: 0 0 8px rgba(64, 158, 255, 0.4);
        }

        .bigShelfBox .shelfBox .shelf.path-highlight {
            background: rgba(64, 158, 255, 0.3) !important;
        }

        .bigShelfBox .shelfBox .shelf.path-current {
            background: rgba(64, 158, 255, 0.8) !important;
            box-shadow: 0 0 10px rgba(64, 158, 255, 0.8);
        }

        .context-menu {
            position: fixed;
            z-index: 9999;
            min-width: 180px;
            max-width: 280px;
            padding: 8px 0;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            border: 1px solid #e4e7ed;
        }
        .context-menu__title {
            padding: 8px 16px 6px;
            font-size: 11px;
            font-weight: 600;
            color: #909399;
            border-bottom: 1px solid #f0f2f5;
            margin-bottom: 4px;
        }
        .context-menu__item {
            padding: 6px 16px;
            font-size: 11px;
            color: #606266;
            line-height: 1.5;
            display: flex;
            justify-content: space-between;
        }
        .context-menu__label {
            color: #909399;
            margin-right: 8px;
        }
        .context-menu__value {
            color: #303133;
            font-weight: 500;
        }

        .overview-toolbar {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .grid-settings {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .grid-settings label {
            font-size: 14px;
            color: #606266;
        }
        
        .grid-settings input {
            width: 60px;
            height: 32px;
            border: 1px solid #dcdfe6;
            border-radius: 4px;
            padding: 0 8px;
        }

        .path-toolbar {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }
        
        .path-toolbar .btn {
            min-width: 120px;
        }
        
        .path-toolbar__status {
            font-size: 13px;
            color: #606266;
        }
        
        .path-toolbar__meta {
            font-size: 13px;
            color: #909399;
        }

        .selection-hint {
            font-size: 14px;
            color: #606266;
        }

        .shelfBottomNav {
            width: 88%;
            margin-top: 30px;
            border-top: 1px solid #EBEEF5;
            padding-top: 20px;
        }

        .shelfNav {
            border-left: 4px solid #409eff;
            margin-left: 2%;
            margin-right: 2%;
            padding-left: 12px;
            padding-right: 12px;
            padding-top: 8px;
            padding-bottom: 8px;
            float: left;
            border-radius: 4px;
            background: #f7f8fc;
        }

        .shelfNav p {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .colorBlock {
            display: inline-block;
            width: 50px;
            height: 20px;
            border: 1px solid #DCDFE6;
            border-radius: 4px;
            float: left;
        }

        .colorBlock.notHave {
            background: #d3d3d3;
        }

        .colorBlock.have {
            background: #90ee90;
        }

        .colorBlock.select {
            background: #f08080;
        }

        .colorBlock.warning {
            background: orange;
        }

        .colorBlockTitle {
            display: inline-block;
            height: 20px;
            line-height: 20px;
            float: left;
            margin-left: 10px;
        }

        .colorBlockNumber {
            display: inline-block;
            height: 20px;
            line-height: 20px;
            float: left;
            margin-left: 10px;
            color: red;
        }

        .p_Title {
            display: inline-block;
            height: 20px;
            line-height: 20px;
            float: left;
        }

        .route-panel {
            margin-top: 30px;
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #EBEEF5;
            background: #F8F9FB;
            clear: both;
        }
        
        .route-panel h4 {
            font-size: 16px;
            margin-bottom: 12px;
            font-weight: 600;
        }
        
        .route-panel ol {
            margin-left: 18px;
            color: #606266;
        }

        .empty-tip {
            text-align: center;
            color: #909399;
            padding: 40px 0;
        }

        .next-step {
            margin-top: 12px;
            font-size: 14px;
            color: #606266;
        }
        
        .next-step a {
            color: #409EFF;
        }
    </style>
</head>
<body>
<div id="area-overview" class="container-div" v-cloak onmousemove="parent.updateTimeOut()" onkeyup="parent.lock(event)">
    <div class="overview-toolbar">
        <div class="grid-settings">
            <label>每行显示:</label>
            <input type="number" v-model.number="gridSettings.columns" @change="handleGridSettingsChange" min="1" max="20">
            <label>最小行数:</label>
            <input type="number" v-model.number="gridSettings.minRows" @change="handleGridSettingsChange" min="1" max="20">
        </div>
        <div class="btn-group">
            <button class="btn btn-warning" @click="clearSelections" :disabled="!selectedAreaIds.length && !pathData">清空</button>
        </div>
        <div class="selection-hint">
            已选择 {{ selectedAreaIds.length }} 个货区
        </div>
    </div>

    <div class="path-toolbar">
        <button class="btn btn-success" @click="startPathfinding" :disabled="selectedAreaIds.length === 0">计算路径</button>
        <button class="btn btn-primary" @click="startSimulation" :disabled="!canStartSimulation">开始模拟路径</button>
        <button class="btn btn-default" @click="togglePause" :disabled="!canTogglePause">
            {{ pathSimulation.paused ? '继续' : '暂停' }}
        </button>
        <button class="btn btn-warning" @click="stopSimulation" :disabled="!canStopSimulation">停止模拟</button>
        <span class="path-toolbar__status" v-if="pathData">
            状态：<strong>{{ pathStatusText }}</strong>
        </span>
        <span class="path-toolbar__meta" v-if="pathData && pathData.distance">
            预计步数：{{ pathData.distance }}
        </span>
    </div>

    <div class="bigShelfBox rightBox clearFloat" style="position: relative;" v-if="displayCells.length">
        <canvas id="areaPathCanvas" style="position: absolute; top: 0; left: 0; pointer-events: none; z-index: 100;"></canvas>
        <div class="shelfBox" :style="style[index]" v-for="(cell, index) in displayCells" :key="cell.key">
            <div class="shelf"
                 :class="cellClass(cell)"
                 :data-row="cell.layoutRow"
                 :data-col="cell.layoutCol"
                 @contextmenu.prevent="cell.area && showContextMenu(cell, $event)"
                 @click="cell.area && toggleSelection(cell.area.areaId)">
                <span v-if="cell.area && getRouteBadge(cell.area.areaId)">
                    {{ getRouteBadge(cell.area.areaId) }}
                </span>
            </div>
        </div>
    </div>

    <div class="context-menu" v-if="contextMenu.visible" :style="contextMenu.style" @click.stop>
        <div class="context-menu__title">{{ contextMenu.title }}</div>
        <div class="context-menu__item" v-for="item in contextMenu.items" :key="item.label">
            <span class="context-menu__label">{{ item.label }}:</span>
            <span class="context-menu__value">{{ item.value }}</span>
        </div>
    </div>

    <div class="shelfBottomNav rightBox clearFloat" style="padding: 10px;" v-if="displayCells.length">
        <div class="shelfNav">
            <p class="clearFloat">
                <span class="colorBlock notHave"></span>
                <span class="colorBlockTitle">空闲</span>
            </p>
            <p class="clearFloat">
                <span class="p_Title">合计</span>
                <span class="colorBlockTitle">:</span>
                <span class="colorBlockNumber">{{areaStats.empty}}</span>
            </p>
        </div>
        <div class="shelfNav">
            <p class="clearFloat">
                <span class="colorBlock have"></span>
                <span class="colorBlockTitle">使用中</span>
            </p>
            <p class="clearFloat">
                <span class="p_Title">合计</span>
                <span class="colorBlockTitle">:</span>
                <span class="colorBlockNumber">{{areaStats.occupied}}</span>
            </p>
        </div>
    </div>

    <div class="empty-tip" v-if="!displayCells.length">
        暂无货区数据
    </div>

    <div class="route-panel" v-if="orderedAreas.length">
        <h4>推荐访问顺序（共 {{ orderedAreas.length }} 个）</h4>
        <ol>
            <li v-for="(area, idx) in orderedAreas" :key="area.areaId">
                {{ area.areaName || ('货区' + (idx + 1)) }}
            </li>
        </ol>
        <p v-if="pathData">路径长度：{{ pathData.distance }} 步</p>
        <div class="next-step">
            下一步：按照顺序到 <a th:href="@{/system/shelfOverview}" target="_blank">货架一览</a> 继续规划。
        </div>
    </div>
</div>

<div th:include="include::footer"></div>
<script th:src="@{/js/pathfinding/pathfinding.js}"></script>
<script th:src="@{/js/pathfinding/warehouse-path-visualizer.js}"></script>
<script th:src="@{/ruoyi/in/areaOverview.js}"></script>
</body>
</html>

