# 路径动画防穿模优化说明

## 问题分析

### 原始问题
路径行走的圆会穿过格子（穿模），影响视觉效果。

### 根本原因

1. **通道宽度有限**：
   - CSS定义：`.bigShelfBox .shelfBox { padding: 8px; }`
   - 通道宽度 = padding × 2 = 16px

2. **圆的半径太大**：
   - 原始核心圆半径：8px
   - 原始外层光晕半径：18px
   - **18px > 16px** → 必然穿模！

3. **圆心位置不对**：
   - 原始圆心在通道边界上（x=0, x=225px...）
   - 圆有半径，所以边缘会伸入格子区域

## 解决方案

### 1. 圆心偏移到通道中心

**原始坐标计算：**
```javascript
const x = (pos.col / 2) * cellWidth;  // 圆心在通道边界
const y = (pos.row / 2) * cellHeight;
```

**优化后的坐标计算：**
```javascript
const paddingPx = 8;  // CSS中定义的padding固定值
const x = (pos.col / 2) * cellWidth + paddingPx;  // 圆心偏移到通道中心
const y = (pos.row / 2) * cellHeight + paddingPx;
```

**示意图：**
```
原始位置:           优化后:
|----格子----|      |----格子----|
●←圆心在边界         ......●←圆心在通道中心
|--16px通道--|      |--16px通道--|
|----格子----|      |----格子----|
```

### 2. 减小圆的半径

**原始尺寸：**
- 核心圆：8px
- 中层光晕：12px
- 外层光晕：18px（超出通道！）

**优化后的尺寸：**
```javascript
const paddingPx = 8;
const channelWidth = paddingPx * 2;  // 16px
const maxRadius = Math.min(channelWidth * 0.45, 7);  // 约7px

// 核心圆：7px
// 中层光晕：7 × 1.3 = 9.1px
// 外层光晕：7 × 1.8 = 12.6px（小于16px，不穿模！）
```

### 3. 路径可视化增强（保留）

- ✅ 已走过的路径：彩色渐变实线（蓝→绿→黄），6px粗
- ✅ 未走过的路径：灰色虚线，3px
- ✅ 起点标记：蓝色圆点 + 白边
- ✅ 终点标记：黄色圆点 + 白边
- ✅ 穿模检测：控制台实时监控

## 技术细节

### 坐标系统

```
layoutCols = 4（4个格子）
canvasWidth = 900px
cellWidth = 900 / 4 = 225px（一个单元的总宽度）

通道位置：
- 第0条通道：x = 0 + 8 = 8px（圆心）
- 第1条通道：x = 225 + 8 = 233px（圆心）
- 第2条通道：x = 450 + 8 = 458px（圆心）
- 第3条通道：x = 675 + 8 = 683px（圆心）
```

### 防穿模计算

```javascript
通道宽度 = 16px
圆心位于通道中心，距离两侧格子各 8px
圆的最大半径 = 16px × 0.45 = 7.2px
圆的最大直径 = 7.2px × 2 = 14.4px
剩余安全边距 = 16px - 14.4px = 1.6px（左右各0.8px）
```

### 自适应尺寸

圆的大小根据通道宽度自动调整：
```javascript
const maxRadius = Math.min(channelWidth * 0.45, 7);
```
- 如果通道更窄，圆会自动变小
- 最大半径限制为7px，保持可见性

## 更新的文件

1. `wms-admin/src/main/resources/static/ruoyi/in/areaOverview.js`
2. `wms-admin/src/main/resources/static/ruoyi/in/shelfOverview.js`
3. `wms-admin/target/classes/static/ruoyi/in/areaOverview.js`
4. `wms-admin/target/classes/static/ruoyi/in/shelfOverview.js`

## 效果对比

### 优化前
- ❌ 圆心在通道边界
- ❌ 外层光晕18px > 通道16px
- ❌ 圆明显穿过格子

### 优化后
- ✅ 圆心在通道正中心
- ✅ 外层光晕12.6px < 通道16px
- ✅ 圆完全在通道内，不穿模
- ✅ 留有1.6px安全边距

## 使用说明

1. **硬刷新浏览器**：按 `Ctrl+F5` 清除缓存
2. 进入货区概览或货架概览页面
3. 运行路径模拟
4. 观察效果：
   - 圆应该完全在通道中间
   - 不会触碰到格子
   - 路径清晰可见（彩色实线 + 灰色虚线）

## 调整参数

如果还有轻微穿模，可以调整以下参数：

### 减小圆的半径
在 `drawPathAnimated` 函数中：
```javascript
const maxRadius = Math.min(channelWidth * 0.45, 7);  // 减小0.45的值
// 例如改为 0.4 或 0.35
```

### 调整padding偏移
在 `pathPoints` 计算中：
```javascript
const paddingPx = 8;  // 如果CSS的padding不是8px，修改此值
```

### 减小外层光晕
```javascript
ctx.arc(marker.x, marker.y, maxRadius * 1.8, 0, Math.PI * 2);
// 减小1.8的倍数，例如改为1.5
```

## 穿模检测

打开浏览器控制台（F12），如果看到警告：
```
检测到潜在穿模！圆心位置: {gridRow: 3, gridCol: 5, x: 458, y: 233}
```

说明路径规划算法返回了非法的坐标（奇数值）。正常情况下不应该有此警告。

## 技术总结

防穿模的关键三要素：
1. **圆心对齐**：偏移到通道中心（+8px）
2. **尺寸控制**：圆的直径 < 通道宽度
3. **安全边距**：留有1-2px缓冲空间

通过这三点，确保圆形标记完全在通道内运行，绝对不会穿过格子！

