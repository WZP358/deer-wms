# 路径穿模问题 - 根本原因和修复

## 🔍 问题根源

路径穿模的**根本原因**不是圆的大小，而是**目标位置计算错误**！

### 错误的实现

#### 1. 目标位置计算（getAreaPositionById / getShelfPositionById）

**❌ 错误的代码：**
```javascript
return {
    row: cell.gridRow + 1,  // 奇数+1 = 偶数（通道）✓
    col: cell.gridCol       // 奇数（格子）❌
};
```

**问题：**
- `gridRow` 和 `gridCol` 是奇数（1, 3, 5...），代表格子位置
- `row` 加了1变成偶数（2, 4, 6...），是通道 ✓
- 但 `col` 没有变化，仍然是奇数，**还在格子上** ❌

**结果：**
- 目标位置是 `(偶数行, 奇数列)` = `(通道, 格子)`
- 路径必然从格子列穿过！

#### 2. 入口位置计算（getEntrancePosition）

**❌ 错误的代码：**
```javascript
const middleCell = Math.max(1, Math.ceil(this.boardMetrics.layoutCols / 2));
const col = (middleCell - 1) * 2 + 1;  // 计算结果是奇数！
return {
    row: 0,      // 偶数（通道）✓
    col: col     // 奇数（格子）❌
};
```

**举例（layoutCols = 4）：**
- `middleCell = 2`
- `col = (2-1)*2+1 = 3` （奇数）
- 入口在 `(0, 3)` = `(通道, 格子)`
- 入口就在格子上！

### 坐标系统说明

```
网格布局示例（layoutCols = 4）：

gridCol:  0   1   2   3   4   5   6   7   8
          |   |   |   |   |   |   |   |   |
          通  格  通  格  通  格  通  格  通
          道  子  道  子  道  子  道  子  道

格子位置：1, 3, 5, 7（奇数）
通道位置：0, 2, 4, 6, 8（偶数）
```

**规则：**
- ✅ 路径只能在**通道交叉点**上（行和列都是偶数）
- ❌ 不能在格子上（奇数坐标）

## ✅ 正确的实现

### 1. 目标位置计算

**✅ 修复后的代码：**
```javascript
return {
    row: cell.gridRow - 1,  // 奇数-1 = 偶数（通道）✓
    col: cell.gridCol - 1   // 奇数-1 = 偶数（通道）✓
};
```

**说明：**
- 格子在 `(1, 1)`，目标在 `(0, 0)` - 格子左上角的通道交叉点
- 格子在 `(3, 5)`，目标在 `(2, 4)` - 格子左上角的通道交叉点
- **行和列都是偶数**，确保在通道交叉点上

### 2. 入口位置计算

**✅ 修复后的代码：**
```javascript
const middleCell = Math.max(1, Math.ceil(this.boardMetrics.layoutCols / 2));
const col = (middleCell - 1) * 2;  // 去掉+1，结果是偶数
return {
    row: 0,      // 偶数（通道）✓
    col: col     // 偶数（通道）✓
};
```

**举例（layoutCols = 4）：**
- `middleCell = 2`
- `col = (2-1)*2 = 2` （偶数）✓
- 入口在 `(0, 2)` = `(通道, 通道)`
- 正确！

## 📐 完整的坐标验证

### 示例：4列布局

```
gridCols = 4 * 2 + 1 = 9

     0   2   4   6   8  ← 通道列（偶数）
   ┌───┬───┬───┬───┬───┐
 0 │ ● │   │ ★ │   │   │ ← 通道行（偶数）
   ├───┼───┼───┼───┼───┤
 1 │   │[1]│   │[2]│   │ ← 格子行（奇数）
   ├───┼───┼───┼───┼───┤
 2 │   │   │   │   │   │ ← 通道行（偶数）
   ├───┼───┼───┼───┼───┤
 3 │   │[3]│   │[4]│   │ ← 格子行（奇数）
   └───┴───┴───┴───┴───┘

● 入口：(0, 2) - 都是偶数 ✓
★ 格子[1]在(1,1)，目标(0,0) - 都是偶数 ✓
  格子[2]在(1,3)，目标(0,2) - 都是偶数 ✓
```

所有位置都在通道交叉点上，路径不会穿过格子！

## 🎯 修复总结

### 改动的函数

1. **areaOverview.js**
   - `getAreaPositionById()` - 目标位置从 `(+1, 不变)` 改为 `(-1, -1)`
   - `getEntrancePosition()` - 入口列从 `奇数` 改为 `偶数`

2. **shelfOverview.js**
   - `getShelfPositionById()` - 目标位置从 `(+1, 不变)` 改为 `(-1, -1)`
   - `getEntrancePosition()` - 入口列从 `奇数` 改为 `偶数`

### 核心原则

> **所有路径点（起点、终点、目标点）必须在通道交叉点上**  
> **通道交叉点 = 行和列都是偶数坐标**

### 其他优化（保留）

- ✅ 圆心偏移到通道中心（+8px）
- ✅ 减小圆的半径（适应通道宽度）
- ✅ 已走/未走路径可视化（彩色实线/灰色虚线）
- ✅ 穿模实时检测

## 🚀 测试验证

### 测试步骤

1. **硬刷新浏览器**：`Ctrl + F5`
2. 进入货区概览或货架概览页面
3. 选择多个货区/货架
4. 点击"计算路径"
5. 点击"开始模拟路径"

### 预期结果

- ✅ 路径完全在通道中行走
- ✅ 不穿过任何格子
- ✅ 入口位置正确
- ✅ 到达每个目标时，位置在格子旁边的通道交叉点上
- ✅ 已走路径显示为彩色实线
- ✅ 未走路径显示为灰色虚线

### 控制台验证

打开浏览器控制台（F12），应该看到：

```javascript
路径规划参数: {
  gridSize: "9x9",
  start: {row: 0, col: 2},      // 都是偶数 ✓
  targets: [
    {row: 0, col: 0},           // 都是偶数 ✓
    {row: 2, col: 4},           // 都是偶数 ✓
    {row: 4, col: 2}            // 都是偶数 ✓
  ],
  layoutCols: 4,
  layoutRows: 3
}
```

**所有坐标都是偶数才是正确的！**

## 📝 技术细节

### 为什么选择左上角通道交叉点？

```javascript
row: cell.gridRow - 1,
col: cell.gridCol - 1
```

- **简单**：只需要减1，计算简单
- **安全**：避免边界问题（加1可能超出网格）
- **自然**：路径从左上方接近格子，符合从入口（顶部）往下的流向

### 其他可选方案

也可以选择其他通道交叉点：

```javascript
// 右上角
{row: cell.gridRow - 1, col: cell.gridCol + 1}

// 左下角
{row: cell.gridRow + 1, col: cell.gridCol - 1}

// 右下角
{row: cell.gridRow + 1, col: cell.gridCol + 1}
```

只要确保**行和列都是偶数**即可！

## 🎉 结论

路径穿模的根本原因是**坐标计算错误**，而不是圆的大小或位置。

通过确保所有路径点都在通道交叉点上（偶数坐标），彻底解决了穿模问题！

---

**更新的文件：**
1. `wms-admin/src/main/resources/static/ruoyi/in/areaOverview.js`
2. `wms-admin/src/main/resources/static/ruoyi/in/shelfOverview.js`
3. `wms-admin/target/classes/static/ruoyi/in/areaOverview.js`
4. `wms-admin/target/classes/static/ruoyi/in/shelfOverview.js`

